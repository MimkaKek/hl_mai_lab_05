# Домашняя работа №4 - Circuit Breaker

## Цель

Получение практических навыков в построении отказоустойчивых приложений.

## Задание

Необходимо реализовать сервис API Gateway, который будет получать JWT токен в
User Service и вызывать сервисы согласно варианту задания.
Для вызова сервисов, согласно варианту задания реализовать паттерн Circuit Breaker.

## Решение

Изначально я пробовал реализовать собственный вариант Circuit Breaker, но по итогу отказался от него, так как сильно переусложнил его. Посмотрел в примере Дзюбы, что всё гораздо проще. Взял его за основу и постарался аккуратно вставить в проект, внося нужные изменения.

Алгоритм в Gateway следующий:

1. Получение запроса.
2. Если это регистрация пользователя - проверка в Circuit Breaker, что сервис пользователей исправен. Если всё в порядке - перенаправляет запрос на регистрацию сервису. В зависимости от ответа сервиса, вносит изменения в Circuit Breaker.
3. Если это что-то иное - смотрит метод запроса. Если метод GET - запрашивает данные из кэша. Если данных нет - обращается к сервисам.
4. Перед обращением к сервису идёт проверка в Circuit Breaker. Если сервис недоступен - возвращает пользователю ошибку.
5. Если сервис доступен, обращается за JWT токеном к сервису пользователей и затем уже обращается к нужному сервису.
6. В зависимости от ответа сервиса вносит изменения в Circuit Breaker.

После внедрения Circuit Breaker инициализация базы данных идёт крайне плохо, потому что какие-то из запросов на регистрацию пользователей не проходят успешно из-за длины хэша пароля. Если таких проблемных запросов набирается достаточно много, то Circuit Breaker блокирует доступ, из-за чего отметаются последующие запросы к сервису.

Как опция можно поменять количество допустимых ошибок перед блокировкой. Либо как-то с хэшем похимичить, чтобы не выдавало огромные значения для PostgreSQL. Либо использовать другой тип данных для хэшей, но тут я не очень уверен, что может подойти - первое, что на ум приходит, так это хранить хэши как строки.

## Справочная информация

### OpenAPI 3.0 
Он оказался слишком громоздким для одного файла index.yaml, поэтому я разделил на 4 файла (на каждый сервис) и поместил в папку [docs](https://github.com/MimkaKek/hl_mai_lab_05/tree/main/docs). 

Gateway по сути реализует все указанные там запросы, но по порту 8888.

### Запуск
Для запуска достаточно команды

```
docker compose up
```

### Заполнение БД
Скрипт заполнения баз данных реализован в файле [init_db.py](https://github.com/MimkaKek/hl_mai_lab_05/blob/main/init_db.py). К нему прилагаются нужные пакеты в [requerments.txt](https://github.com/MimkaKek/hl_mai_lab_05/blob/main/requirements.txt).
